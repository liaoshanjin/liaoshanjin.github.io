<!DOCTYPE html>
<html lang="cn">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    
    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="自定义接口 response 和 异常"/>
<meta name="twitter:description" content="封装返回的统一消息 接口主流返回 json 格式，其中包含 http状态码，status请求状态，data请求资源结果等等。需要我们有一个 API 接口全局都能有统一的格式和对应的数据处理。
在 app/Api/Helpers 目录 (不存在目录自己新建) 下新建 ApiResponse.php 填入如下内容
&lt;?php namespace App\Api\Helpers; use Symfony\Component\HttpFoundation\Response as HttpBaseResponse; /** * Trait ApiResponse * * @package App\Api\Helpers */ trait ApiResponse { /** * @var int */ protected $httpCode = HttpBaseResponse::HTTP_OK; /** * 设置 Http 的状态码 * * @param $code * * @return $this */ public function setHttpCode($code) { $this-&gt;httpCode = $code; return $this; } /** * 获取 Http 状态码 * * @return int */ public function getHttpCode() { return $this-&gt;httpCode; } /** * 最基础的一个返回 json * * @param $data * @param array $header * * @return \Illuminate\Http\JsonResponse */ public function baseResponse($data, $header = []) { return \Response::json($data, $this-&gt;getHttpCode(), $header); } /** * 定义返回的格式 * * @param array $data * @param $messageStatus * @param null $httpCode * * @return \Illuminate\Http\JsonResponse */ public function status(array $data, $messageStatus, $httpCode = null) { if ( !"/>

    <meta property="og:title" content="自定义接口 response 和 异常" />
<meta property="og:description" content="封装返回的统一消息 接口主流返回 json 格式，其中包含 http状态码，status请求状态，data请求资源结果等等。需要我们有一个 API 接口全局都能有统一的格式和对应的数据处理。
在 app/Api/Helpers 目录 (不存在目录自己新建) 下新建 ApiResponse.php 填入如下内容
&lt;?php namespace App\Api\Helpers; use Symfony\Component\HttpFoundation\Response as HttpBaseResponse; /** * Trait ApiResponse * * @package App\Api\Helpers */ trait ApiResponse { /** * @var int */ protected $httpCode = HttpBaseResponse::HTTP_OK; /** * 设置 Http 的状态码 * * @param $code * * @return $this */ public function setHttpCode($code) { $this-&gt;httpCode = $code; return $this; } /** * 获取 Http 状态码 * * @return int */ public function getHttpCode() { return $this-&gt;httpCode; } /** * 最基础的一个返回 json * * @param $data * @param array $header * * @return \Illuminate\Http\JsonResponse */ public function baseResponse($data, $header = []) { return \Response::json($data, $this-&gt;getHttpCode(), $header); } /** * 定义返回的格式 * * @param array $data * @param $messageStatus * @param null $httpCode * * @return \Illuminate\Http\JsonResponse */ public function status(array $data, $messageStatus, $httpCode = null) { if ( !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liaoshanjin.github.io/laravel/larave-response-exception/" />
<meta property="article:published_time" content="2019-10-24T17:09:10+08:00" />
<meta property="article:modified_time" content="2019-10-24T17:09:10+08:00" />


    
      <base href="https://liaoshanjin.github.io/laravel/larave-response-exception/">
    
    <title>
  自定义接口 response 和 异常 · 苦味糖的博客
</title>

    
      <link rel="canonical" href="https://liaoshanjin.github.io/laravel/larave-response-exception/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    

    

    
    
    <link rel="icon" type="image/png" href="https://liaoshanjin.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://liaoshanjin.github.io/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.75.1" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      苦味糖的博客
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>自定义接口 response 和 异常</h1>
    </header>

    <h3 id="封装返回的统一消息">封装返回的统一消息</h3>
<p>接口主流返回 <code>json</code> 格式，其中包含 <code>http状态码</code>，<code>status请求状态</code>，<code>data请求资源结果</code>等等。需要我们有一个 API 接口全局都能有统一的格式和对应的数据处理。</p>
<p>在 <code>app/Api/Helpers</code> 目录 (不存在目录自己新建) 下新建 <code>ApiResponse.php</code> 填入如下内容</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">App\Api\Helpers</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Symfony\Component\HttpFoundation\Response</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">HttpBaseResponse</span>;

<span style="color:#e6db74">/**
</span><span style="color:#e6db74"> * Trait ApiResponse
</span><span style="color:#e6db74"> *
</span><span style="color:#e6db74"> * @package App\Api\Helpers
</span><span style="color:#e6db74"> */</span>
<span style="color:#66d9ef">trait</span>  <span style="color:#a6e22e">ApiResponse</span>
{

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * @var int
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">protected</span> $httpCode <span style="color:#f92672">=</span> <span style="color:#a6e22e">HttpBaseResponse</span><span style="color:#f92672">::</span><span style="color:#a6e22e">HTTP_OK</span>;


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 设置 Http 的状态码
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param $code
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return $this
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setHttpCode</span>($code)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">httpCode</span> <span style="color:#f92672">=</span> $code;

        <span style="color:#66d9ef">return</span> $this;
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 获取 Http 状态码
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return int
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getHttpCode</span>()
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">httpCode</span>;
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 最基础的一个返回 json
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param       $data
</span><span style="color:#e6db74">     * @param array $header
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">baseResponse</span>($data, $header <span style="color:#f92672">=</span> [])
    {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">\Response</span><span style="color:#f92672">::</span><span style="color:#a6e22e">json</span>($data, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getHttpCode</span>(), $header);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 定义返回的格式
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param array $data
</span><span style="color:#e6db74">     * @param       $messageStatus
</span><span style="color:#e6db74">     * @param null  $httpCode
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">status</span>(<span style="color:#66d9ef">array</span> $data, $messageStatus, $httpCode <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>)
    {
        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span> <span style="color:#a6e22e">is_null</span>($httpCode)) {
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setHttpCode</span>($httpCode);
        }

        $format <span style="color:#f92672">=</span> [
            <span style="color:#e6db74">&#39;status&#39;</span> <span style="color:#f92672">=&gt;</span> $messageStatus,
            <span style="color:#e6db74">&#39;code&#39;</span>   <span style="color:#f92672">=&gt;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">httpCode</span>,
        ];

        $responseArray <span style="color:#f92672">=</span> <span style="color:#a6e22e">array_merge</span>($format, $data);

        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">baseResponse</span>($responseArray);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 默认成功的消息返回
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param        $message
</span><span style="color:#e6db74">     * @param string $messageStatus
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">message</span>($message, $messageStatus <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;success&#39;</span>)
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">status</span>([<span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> $message], $messageStatus);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 数据返回
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param        $data
</span><span style="color:#e6db74">     * @param string $messageStatus
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">success</span>($data, $messageStatus <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;success&#39;</span>)
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">status</span>([<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> $data], $messageStatus);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 默认错误的消息返回
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param        $message
</span><span style="color:#e6db74">     * @param string $messageStatus
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">error</span>($message, $messageStatus <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>)
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">status</span>([<span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> $message], $messageStatus);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 错误的时候消息返回
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param        $message
</span><span style="color:#e6db74">     * @param int    $httpCode
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">failed</span>($message, $httpCode <span style="color:#f92672">=</span> <span style="color:#a6e22e">HttpBaseResponse</span><span style="color:#f92672">::</span><span style="color:#a6e22e">HTTP_BAD_REQUEST</span>)
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setHttpCode</span>($httpCode)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>($message);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 服务器错误返回
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param string $message
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">internalError</span>($message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;服务器内部错误&#34;</span>)
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">failed</span>($message, <span style="color:#a6e22e">HttpBaseResponse</span><span style="color:#f92672">::</span><span style="color:#a6e22e">HTTP_INTERNAL_SERVER_ERROR</span>);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 创建成功的时候提示
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param string $message
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">created</span>($message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;created&#39;</span>)
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setHttpCode</span>(<span style="color:#a6e22e">HttpBaseResponse</span><span style="color:#f92672">::</span><span style="color:#a6e22e">HTTP_CREATED</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>($message);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 删除时的返回
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param string $message
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">deleted</span>($message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;deleted&#39;</span>)
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setHttpCode</span>(<span style="color:#a6e22e">HttpBaseResponse</span><span style="color:#f92672">::</span><span style="color:#a6e22e">HTTP_NO_CONTENT</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>($message);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 没有找到的错误
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param string $message
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">notFound</span>($message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Not Found&#39;</span>)
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setHttpCode</span>(<span style="color:#a6e22e">HttpBaseResponse</span><span style="color:#f92672">::</span><span style="color:#a6e22e">HTTP_NOT_FOUND</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>($message);
    }


}
</code></pre></div><h3 id="异常自定义处理">异常自定义处理</h3>
<p>在 <code>app/Api/Helpers</code> 目录下新建 <code>ExceptionReport.php</code> 文件，填入以下内容：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">App\Api\Helpers</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Exception</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Auth\Access\AuthorizationException</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Auth\AuthenticationException</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Database\Eloquent\ModelNotFoundException</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Http\Request</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Support\Arr</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Validation\ValidationException</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Symfony\Component\HttpKernel\Exception\MethodNotAllowedHttpException</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Symfony\Component\HttpKernel\Exception\NotFoundHttpException</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException</span>;


<span style="color:#e6db74">/**
</span><span style="color:#e6db74"> * Class ExceptionReport
</span><span style="color:#e6db74"> *
</span><span style="color:#e6db74"> * @package App\Api\Helpers
</span><span style="color:#e6db74"> */</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExceptionReport</span>
{

    <span style="color:#66d9ef">use</span> <span style="color:#a6e22e">ApiResponse</span>;

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * @var
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> $exception;

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * @var
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> $request;

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * @var
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">protected</span> $report;


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * @var array
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> $doReport <span style="color:#f92672">=</span> [
        <span style="color:#a6e22e">UnauthorizedHttpException</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>     <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;未登录或者登录已失效&#39;</span>, <span style="color:#ae81ff">401</span>],
        <span style="color:#a6e22e">MethodNotAllowedHttpException</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;访问方式不正确&#39;</span>, <span style="color:#ae81ff">405</span>],
        <span style="color:#a6e22e">NotFoundHttpException</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>         <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;访问的路由不存在&#39;</span>, <span style="color:#ae81ff">404</span>],
        <span style="color:#a6e22e">ModelNotFoundException</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>        <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;模型没有找到&#39;</span>, <span style="color:#ae81ff">404</span>],
        <span style="color:#a6e22e">AuthorizationException</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>        <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;没有此权限&#39;</span>, <span style="color:#ae81ff">403</span>],
        <span style="color:#a6e22e">AuthenticationException</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>       <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;未授权的访问&#39;</span>, <span style="color:#ae81ff">401</span>],
        <span style="color:#a6e22e">ValidationException</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>           <span style="color:#f92672">=&gt;</span> [],
    ];


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * ExceptionReport constructor.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param $exception
</span><span style="color:#e6db74">     * @param $request
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct(<span style="color:#a6e22e">Exception</span> $exception, <span style="color:#a6e22e">Request</span> $request)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exception</span> <span style="color:#f92672">=</span> $exception;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">request</span>   <span style="color:#f92672">=</span> $request;
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 接管错误异常
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param \Exception $exception
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \App\Api\Helpers\ExceptionReport
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">make</span>(<span style="color:#a6e22e">Exception</span> $exception)
    {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">static</span>($exception, <span style="color:#a6e22e">\request</span>());
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 判断异常是否已经自定义
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return bool
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">canReport</span>()
    {
        <span style="color:#66d9ef">foreach</span> (<span style="color:#a6e22e">array_keys</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">doReport</span>) <span style="color:#66d9ef">as</span> $exception) {
            <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exception</span> <span style="color:#a6e22e">instanceof</span> $exception) {
                $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">report</span> <span style="color:#f92672">=</span> $exception;

                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
            }
        }

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 反馈自定义的异常
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">report</span>()
    {
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exception</span> <span style="color:#a6e22e">instanceof</span> <span style="color:#a6e22e">ValidationException</span>) {
            $error <span style="color:#f92672">=</span> <span style="color:#a6e22e">Arr</span><span style="color:#f92672">::</span><span style="color:#a6e22e">first</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exception</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">errors</span>());

            <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">failed</span>(<span style="color:#a6e22e">Arr</span><span style="color:#f92672">::</span><span style="color:#a6e22e">first</span>($error), $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exception</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">status</span>);
        }

        $message <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">doReport</span>[$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">report</span>];

        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">failed</span>($message[<span style="color:#ae81ff">0</span>], $message[<span style="color:#ae81ff">1</span>]);
    }


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 线上环境时的报错
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">prodReport</span>()
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">failed</span>(<span style="color:#e6db74">&#39;服务器内部错误&#39;</span>, <span style="color:#ae81ff">500</span>);
    }


}
</code></pre></div><h4 id="接管异常">接管异常</h4>
<p>修改 <code>app/Exceptions</code> 目录下的 <code>Handler.php</code> 文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">App\Exceptions</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Api\Helpers\ExceptionReport</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Exception</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Exceptions\Handler</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">ExceptionHandler</span>;

<span style="color:#e6db74">/**
</span><span style="color:#e6db74"> * Class Handler
</span><span style="color:#e6db74"> *
</span><span style="color:#e6db74"> * @package App\Exceptions
</span><span style="color:#e6db74"> */</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">ExceptionHandler</span>
{

    <span style="color:#f92672">....</span>
    <span style="color:#f92672">....</span>
    <span style="color:#f92672">....</span>


    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 重构异常
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param \Illuminate\Http\Request $request
</span><span style="color:#e6db74">     * @param \Exception               $exception
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return \Illuminate\Http\JsonResponse|\Illuminate\Http\Response|\Symfony\Component\HttpFoundation\Response
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">render</span>($request, <span style="color:#a6e22e">Exception</span> $exception)
    {
        <span style="color:#66d9ef">if</span> ($request<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ajax</span>() <span style="color:#f92672">||</span> $request<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">is</span>(<span style="color:#e6db74">&#39;api/*&#39;</span>)) {
            $e <span style="color:#f92672">=</span> <span style="color:#a6e22e">ExceptionReport</span><span style="color:#f92672">::</span><span style="color:#a6e22e">make</span>($exception);
            <span style="color:#66d9ef">if</span> ($e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">canReport</span>()) {
                <span style="color:#66d9ef">return</span> $e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">report</span>();
            }

            <span style="color:#75715e"># 判断是否开启了 Debug ,开启则显示详细异常，否则使用自定义的异常
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">env</span>(<span style="color:#e6db74">&#39;APP_DEBUG&#39;</span>)) {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">render</span>($request, $exception);
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#66d9ef">return</span> $e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">prodReport</span>();
            }

        }

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">render</span>($request, $exception);
    }

}
</code></pre></div>
  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
     © 2020
    
       · 
       <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
